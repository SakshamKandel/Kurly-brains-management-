generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String             @id @default(cuid())
  email                String             @unique
  password             String
  firstName            String
  lastName             String
  avatar               String?
  phone                String?
  department           String?
  position             String?
  role                 Role               @default(STAFF)
  status               UserStatus         @default(ACTIVE)
  lastActive           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  managerId            String?
  mustChangePassword   Boolean            @default(false)
  announcements        Announcement[]
  attendance           Attendance[]
  assignedCredentials  ClientCredential[] @relation("CredentialAssignee")
  createdCredentials   ClientCredential[] @relation("CredentialCreator")
  conversationsAsUser1 Conversation[]     @relation("User1")
  conversationsAsUser2 Conversation[]     @relation("User2")
  customPages          CustomPage[]
  leaveApprovals       LeaveRequest[]     @relation("LeaveApprover")
  leaveRequests        LeaveRequest[]     @relation("LeaveRequester")
  messagesReceived     Message[]          @relation("MessageReceiver")
  messagesSent         Message[]          @relation("MessageSender")
  tasksAssigned        Task[]             @relation("TaskAssignee")
  tasksCreated         Task[]             @relation("TaskCreator")
  manager              User?              @relation("UserManager", fields: [managerId], references: [id])
  reports              User[]             @relation("UserManager")
  preferences          UserPreferences?
  
  // Invoicing
  createdClients       Client[]
  createdInvoices      Invoice[]
  
  // Payroll
  bankDetails          BankDetails?
  salaryInfo           SalaryInfo?
  paymentsSent         Payment[]    @relation("PaymentPayer")
  paymentsReceived     Payment[]    @relation("PaymentPayee")
  customBanksAdded     CustomBank[] @relation("CustomBankAddedBy")
  
  // Security
  auditLogs            AuditLog[]
  
  // Projects & Meetings
  createdProjects      Project[]         @relation("ProjectCreator")
  projectMemberships   ProjectMember[]
  createdMeetings      Meeting[]         @relation("MeetingCreator")
  meetingAttendances   MeetingAttendee[]
  taskComments         TaskComment[]
  conversationMembers  ConversationMember[]
}

model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String   // CREATE, UPDATE, DELETE, VIEW, LOGIN, etc.
  resource    String   // Payment, BankDetails, User, etc.
  resourceId  String?
  details     Json?    // Stores changed fields, before/after values
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([resource])
  @@index([action])
}

model ClientCredential {
  id           String               @id @default(cuid())
  clientName   String
  serviceName  String
  username     String?
  password     String
  apiKey       String?
  url          String?
  notes        String?
  createdById  String
  assignedToId String
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  visibility   CredentialVisibility @default(PRIVATE)
  assignedTo   User                 @relation("CredentialAssignee", fields: [assignedToId], references: [id], onDelete: Cascade)
  createdBy    User                 @relation("CredentialCreator", fields: [createdById], references: [id], onDelete: Cascade)
}

model UserPreferences {
  id             String   @id @default(cuid())
  userId         String   @unique
  navOrder       Json?
  favorites      Json?
  groups         Json?
  workModes      Json?
  activeWorkMode String?
  widgetOrder    Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id          String        @id @default(cuid())
  title       String
  description String?
  priority    Priority      @default(MEDIUM)
  status      TaskStatus    @default(TODO)
  dueDate     DateTime?
  attachments String[]      @default([])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  creatorId   String
  assigneeId  String?
  projectId   String?
  assignee    User?         @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator     User          @relation("TaskCreator", fields: [creatorId], references: [id])
  project     Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)
  comments    TaskComment[]
}

model TaskComment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  taskId    String
  userId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])
}

model Conversation {
  id        String               @id @default(cuid())
  isGroup   Boolean              @default(false)
  name      String?
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  user1Id   String?
  user2Id   String?
  user1     User?                @relation("User1", fields: [user1Id], references: [id])
  user2     User?                @relation("User2", fields: [user2Id], references: [id])
  members   ConversationMember[]
  messages  Message[]
}

model ConversationMember {
  id             String       @id @default(cuid())
  conversationId String
  userId         String
  joinedAt       DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  conversationId String
  senderId       String
  receiverId     String?
  attachments    String[]     @default([])
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  receiver       User?        @relation("MessageReceiver", fields: [receiverId], references: [id])
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])
}

model Attendance {
  id       String           @id @default(cuid())
  date     DateTime         @db.Date
  clockIn  DateTime
  clockOut DateTime?
  status   AttendanceStatus @default(PRESENT)
  notes    String?
  userId   String
  user     User             @relation(fields: [userId], references: [id])

  @@unique([userId, date])
}

model LeaveRequest {
  id          String      @id @default(cuid())
  type        LeaveType
  startDate   DateTime    @db.Date
  endDate     DateTime    @db.Date
  reason      String
  status      LeaveStatus @default(PENDING)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  requesterId String
  approverId  String?
  approver    User?       @relation("LeaveApprover", fields: [approverId], references: [id])
  requester   User        @relation("LeaveRequester", fields: [requesterId], references: [id])
}

model Announcement {
  id          String    @id @default(cuid())
  title       String
  content     String
  priority    Priority  @default(MEDIUM)
  isPublished Boolean   @default(false)
  publishedAt DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  authorId    String
  author      User      @relation(fields: [authorId], references: [id])
}

model CustomPage {
  id        String   @id @default(cuid())
  title     String   @default("Untitled")
  icon      String?  @default("ðŸ“„")
  userId    String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  blocks    Block[]
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Block {
  id        String     @id @default(cuid())
  type      String
  content   Json       @default("{}")
  order     Int        @default(0)
  pageId    String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  page      CustomPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
}

enum Role {
  ADMIN
  MANAGER
  STAFF
  SUPER_ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum CredentialVisibility {
  PRIVATE
  TEAM
  PUBLIC
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  COMPLETED
  CANCELLED
}

enum AttendanceStatus {
  PRESENT
  LATE
  HALF_DAY
  ABSENT
}

enum LeaveType {
  ANNUAL
  SICK
  PERSONAL
  MATERNITY
  PATERNITY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// --- INVOICING MODELS ---

model Client {
  id        String   @id @default(cuid())
  name      String
  email     String?
  address   String?
  phone     String?
  logo      String?
  status    ClientStatus @default(ACTIVE)
  creatorId String?
  creator   User?    @relation(fields: [creatorId], references: [id])
  invoices  Invoice[]
  projects  Project[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}


model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  status        InvoiceStatus @default(DRAFT)
  issueDate     DateTime      @default(now())
  dueDate       DateTime?
  
  clientId      String
  client        Client        @relation(fields: [clientId], references: [id])
  
  creatorId     String
  creator       User          @relation(fields: [creatorId], references: [id])
  
  items         InvoiceItem[]
  
  subtotal      Float
  taxRate       Float         @default(0)
  taxAmount     Float
  total         Float
  notes         String?
  
  billedByName     String?
  billedByPosition String?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
}

model InvoiceItem {
  id          String   @id @default(cuid())
  description String
  quantity    Int
  unitPrice   Float
  total       Float
  invoiceId   String
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

enum InvoiceStatus {
  DRAFT
  COMPLETED
}

// --- PAYROLL MODELS ---

model BankDetails {
  id              String      @id @default(cuid())
  userId          String      @unique
  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  bankName        String
  bankCode        String?     // SWIFT/BIC code
  branchName      String?
  branchCode      String?     // IFSC/Routing number
  accountNumber   String
  accountHolder   String
  accountType     AccountType @default(SAVINGS)
  country         String      @default("NP")
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
}

model SalaryInfo {
  id              String        @id @default(cuid())
  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  baseSalary      Float
  currency        String        @default("NPR")
  payFrequency    PayFrequency  @default(MONTHLY)
  paymentMethod   PaymentMethod @default(BANK_TRANSFER)
  type            SalaryType    @default(FIXED)
  
  taxDeduction    Float         @default(0)
  otherDeductions Float         @default(0)
  deductionNotes  String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

enum SalaryType {
  FIXED
  PROJECT
  HOURLY
}

model Payment {
  id              String        @id @default(cuid())
  payerId         String
  payer           User          @relation("PaymentPayer", fields: [payerId], references: [id])
  payeeId         String
  payee           User          @relation("PaymentPayee", fields: [payeeId], references: [id])
  
  amount          Float
  currency        String        @default("NPR")
  paymentDate     DateTime
  payPeriodStart  DateTime
  payPeriodEnd    DateTime
  
  baseSalary      Float
  deductions      Float
  bonuses         Float         @default(0)
  netPay          Float
  
  status          PaymentStatus @default(PENDING)
  notes           String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

enum AccountType {
  SAVINGS
  CURRENT
  SALARY
}

enum PayFrequency {
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  PER_PROJECT
  ONE_TIME
}

enum PaymentMethod {
  BANK_TRANSFER
  CASH
  CHECK
  UPI
  WALLET
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// --- CUSTOM BANK DATABASE (User-added banks) ---

model CustomBank {
  id            String   @id @default(cuid())
  country       String   // Country code (e.g., "NP", "PK", "IN")
  name          String
  code          String?  // SWIFT/BIC code
  isDigital     Boolean  @default(false)
  
  addedById     String
  addedBy       User     @relation("CustomBankAddedBy", fields: [addedById], references: [id])
  
  isApproved    Boolean  @default(true) // Admin can approve/reject
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([country, name]) // Prevent duplicates
  @@index([country])
}

// --- PROJECT WORKSPACES ---

model Project {
  id          String          @id @default(cuid())
  name        String
  description String?
  color       String          @default("#3b82f6")
  status      ProjectStatus   @default(ACTIVE)
  clientId    String?
  client      Client?         @relation(fields: [clientId], references: [id])
  createdById String
  createdBy   User            @relation("ProjectCreator", fields: [createdById], references: [id])
  tasks       Task[]
  members     ProjectMember[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model ProjectMember {
  id        String      @id @default(cuid())
  projectId String
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  role      ProjectRole @default(MEMBER)
  joinedAt  DateTime    @default(now())

  @@unique([projectId, userId])
}

enum ProjectStatus {
  ACTIVE
  COMPLETED
  ON_HOLD
  ARCHIVED
}

enum ProjectRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// --- MEETING SCHEDULER ---

model Meeting {
  id          String            @id @default(cuid())
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  isVirtual   Boolean           @default(false)
  meetLink    String?
  createdById String
  createdBy   User              @relation("MeetingCreator", fields: [createdById], references: [id])
  attendees   MeetingAttendee[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model MeetingAttendee {
  id        String              @id @default(cuid())
  meetingId String
  meeting   Meeting             @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  userId    String
  user      User                @relation(fields: [userId], references: [id])
  status    MeetingResponseStatus @default(PENDING)
  respondedAt DateTime?

  @@unique([meetingId, userId])
}

enum MeetingResponseStatus {
  PENDING
  ACCEPTED
  DECLINED
  TENTATIVE
}

